<script src="https://open.spotify.com/embed/iframe-api/v1" async></script>

{{ $total_duration := 0 }}
{{ range $.tracks }}
    {{ $total_duration = add $total_duration .duration_ms }}
{{ end }}
{{ $duration_minutes := div $total_duration 60000 | int }}





<div class="space-y-6 from-primary-500 to-secondary-500 rounded-lg p-6 text-white" data-playlist-id="{{ $.id }}" >


    <div class="flex items-center space-x-8 text-sm">
        <span class="flex items-center">
            <svg class="w-5 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"/>
            </svg>
            <span>{{ len $.tracks }} {{ i18n "playlists.tracks" | default "tracks" }}</span>
        </span>
        <span class="flex items-center ml-2">
            <svg class="w-5 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
            </svg>
            <span>{{ $duration_minutes }} {{ i18n "playlists.minutes" | default "minutes" }}</span>
        </span>
    </div>


    {{ if $.description }}
    <p class="text-lg opacity-90 mb-4">{{ $.description | safeHTML }}</p>

    {{ end }}



    <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between py-4">
        <div class="flex items-center space-x-4">
            <div class="relative">

                <input type="text" id="playlist-search" placeholder="{{ i18n "playlists.search_placeholder" | default "Search tracks..." }}"
                       class="px-4 py-2 border border-neutral-300 dark:border-neutral-600 rounded-lg bg-white dark:bg-neutral-800 text-neutral-900 dark:text-neutral-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent">

            </div>
            <select id="sort-select" class="ml-2 px-3 py-2 border border-neutral-300 dark:border-neutral-600 rounded-lg bg-white dark:bg-neutral-800 text-neutral-900 dark:text-neutral-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                <option value="default">{{ i18n "playlists.sort_default" | default "Default Order" }}</option>
                <option value="title">{{ i18n "playlists.sort_title" | default "Title" }}</option>
                <option value="artist">{{ i18n "playlists.sort_artist" | default "Artist" }}</option>
                <option value="album">{{ i18n "playlists.sort_album" | default "Album" }}</option>
                <option value="duration">{{ i18n "playlists.sort_duration" | default "Duration" }}</option>
            </select>
            <div class="flex items-center space-x-2">
                <a href="/{{ $.id }}.m3u" download class="inline-flex items-center px-3 py-2 text-sm font-medium text-neutral-700 dark:text-neutral-300 bg-white dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-600 rounded-lg hover:bg-neutral-50 dark:hover:bg-neutral-700 focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                    M3U
                </a>
                <a href="/{{ $.id }}.json" download class="inline-flex items-center px-3 py-2 text-sm font-medium text-neutral-700 dark:text-neutral-300 bg-white dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-600 rounded-lg hover:bg-neutral-50 dark:hover:bg-neutral-700 focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                    JSON
                </a>
            </div>
        </div>
        <div class="flex items-center space-x-2">
            <span id="track-count" class="text-sm text-neutral-600 dark:text-neutral-400">
                {{ len $.tracks }} {{ i18n "playlists.tracks_showing" | default "tracks" }}
            </span>
            <button id="reset-sort" class="text-sm text-primary-600 dark:text-primary-400 hover:text-primary-800 dark:hover:text-primary-200">
                {{ i18n "playlists.reset" | default "Reset" }}
            </button>
        </div>
    </div>

    */}}

    <!-- No Results Message -->
    <div id="no-results" class="hidden text-center py-12">
        <svg class="mx-auto h-12 w-12 text-neutral-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.47-.881-6.08-2.33"/>
        </svg>
        <h3 class="mt-2 text-sm font-medium text-neutral-900 dark:text-neutral-100">
            {{ i18n "playlists.no_results" | default "No tracks found" }}
        </h3>
        <p class="mt-1 text-sm text-neutral-500 dark:text-neutral-400">
            {{ i18n "playlists.no_results_description" | default "Try adjusting your search terms." }}
        </p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.querySelector('table');
    const tbody = document.getElementById('tracks-tbody');
    const searchInput = document.getElementById('playlist-search');
    const sortSelect = document.getElementById('sort-select');
    const resetButton = document.getElementById('reset-sort');
    const trackCount = document.getElementById('track-count');
    const noResults = document.getElementById('no-results');

    let originalRows = Array.from(tbody.querySelectorAll('tr'));
    let currentSort = { column: 'default', direction: 'asc' };

    // Search functionality
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = tbody.querySelectorAll('tr');
        let visibleCount = 0;

        rows.forEach(row => {
            const title = row.getAttribute('data-title');
            const artist = row.getAttribute('data-artist');
            const album = row.getAttribute('data-album');

            const matches = title.includes(searchTerm) ||
                           artist.includes(searchTerm) ||
                           album.includes(searchTerm);

            row.style.display = matches ? '' : 'none';
            if (matches) visibleCount++;
        });

        trackCount.textContent = `${visibleCount} ${visibleCount === 1 ? 'track' : 'tracks'}`;
        noResults.style.display = visibleCount === 0 ? 'block' : 'none';
    });

    // Sort functionality
    function sortTable(column, direction) {
        const rows = Array.from(tbody.querySelectorAll('tr'));

        rows.sort((a, b) => {
            let aValue, bValue;

            switch(column) {
                case 'title':
                    aValue = a.getAttribute('data-title');
                    bValue = b.getAttribute('data-title');
                    break;
                case 'artist':
                    aValue = a.getAttribute('data-artist');
                    bValue = b.getAttribute('data-artist');
                    break;
                case 'album':
                    aValue = a.getAttribute('data-album');
                    bValue = b.getAttribute('data-album');
                    break;
                case 'duration':
                    aValue = parseInt(a.getAttribute('data-duration'));
                    bValue = parseInt(b.getAttribute('data-duration'));
                    break;
                default:
                    return 0;
            }

            if (direction === 'asc') {
                return aValue > bValue ? 1 : -1;
            } else {
                return aValue < bValue ? 1 : -1;
            }
        });

        rows.forEach(row => tbody.appendChild(row));
    }

    // Sort select change
    sortSelect.addEventListener('change', function() {
        const column = this.value;
        if (column === 'default') {
            resetSort();
        } else {
            currentSort.column = column;
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            sortTable(column, currentSort.direction);
            updateSortIndicators();
        }
    });

    // Header click handlers for sorting
    const headers = table.querySelectorAll('th[data-sort]');
    headers.forEach(header => {
        header.addEventListener('click', function() {
            const column = this.getAttribute('data-sort');
            if (column === 'default') {
                resetSort();
            } else {
                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.direction = 'asc';
                }
                sortTable(column, currentSort.direction);
                updateSortIndicators();

                // Update the select dropdown to match
                sortSelect.value = column;
            }
        });
    });

    // Reset sort
    resetButton.addEventListener('click', resetSort);

    function resetSort() {
        const tbody = table.querySelector('tbody');
        originalRows.forEach(row => tbody.appendChild(row));
        currentSort = { column: 'default', direction: 'asc' };
        updateSortIndicators();
        sortSelect.value = 'default';
    }

    function updateSortIndicators() {
        const headers = table.querySelectorAll('th[data-sort]');
        headers.forEach(header => {
            const icon = header.querySelector('.sort-icon');
            if (header.getAttribute('data-sort') === currentSort.column) {
                icon.style.transform = currentSort.direction === 'asc' ? 'rotate(180deg)' : 'rotate(0deg)';
            } else {
                icon.style.transform = 'rotate(0deg)';
            }
        });
    }
});
</script>
